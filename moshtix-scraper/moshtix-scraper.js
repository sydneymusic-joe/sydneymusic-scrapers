const axios = require('axios');
const cheerio = require('cheerio');
const ObjectsToCsv = require('objects-to-csv');
const nlp = require('compromise');

const searchUrls = 
[1,2,3,5,6,8,10,11,12,14,15,16,17,18,19,20,21,22,23,24,25,26,27,55,56,74,77,92,105,108,111,116,117,125,136,144,147,150,154,160,167,182,183,186,188,189,197,198,201,203,204,206,207,215,216,219,220,226,233,234,239,241,245,254,256,263,268,283,297,308,311,318,322,325,326,332,335,340,343,344,345,346,359,362,363,364,365,389,390,397,400,401,406,407,417,419,426,431,450,452,453,474,485,494,496,502,511,513,520,536,537,543,544,549,559,563,594,597,598,599,602,607,610,613,617,627,628,631,632,635,641,642,644,649,661,673,676,679,695,705,711,714,726,730,734,736,739,742,750,754,755,756,770,778,789,791,793,794,803,804,805,806,808,809,837,840,841,858,860,864,865,866,867,871,874,879,880,891,901,905,913,914,921,925,928,932,944,946,950,965,966,987,998,999,1001,1004,1010,1014,1015,1026,1029,1032,1035,1037,1039,1063,1072,1074,1076,1077,1080,1083,1085,1090,1099,1104,1106,1123,1124,1125,1132,1150,1155,1163,1164,1171,1174,1210,1220,1225,1228,1238,1241,1254,1255,1267,1269,1274,1279,1288,1312,1314,1315,1331,1341,1342,1345,1358,1363,1373,1380,1387,1399,1422,1424,1426,1436,1448,1461,1464,1465,1485,1490,1501,1504,1507,1527,1538,1539,1546,1558,1567,1573,1586,1604,1618,1620,1622,1629,1645,1653,1657,1659,1675,1684,1691,1692,1700,1703,1707,1712,1735,1738,1745,1752,1766,1767,1768,1777,1779,1782,1799,1802,1810,1819,1826,1831,1832,1839,1842,1846,1848,1849,1850,1852,1854,1861,1870,1871,1879,1880,1896,1914,1937,1938,1942,1943,1953,1962,1970,1979,1984,1985,1986,1994,1996,2002,2009,2012,2030,2033,2034,2035,2041,2049,2051,2056,2057,2062,2085,2088,2089,2107,2112,2124,2126,2128,2129,2131,2134,2136,2141,2151,2156,2160,2162,2170,2180,2184,2195,2210,2211,2215,2225,2226,2238,2239,2247,2248,2253,2254,2259,2260,2265,2271,2276,2282,2283,2286,2292,2297,2298,2299,2302,2304,2305,2306,2314,2315,2323,2326,2327,2340,2356,2364,2367,2372,2377,2379,2383,2390,2392,2394,2396,2401,2408,2416,2417,2426,2429,2439,2449,2459,2461,2480,2485,2500,2505,2515,2518,2523,2525,2529,2542,2560,2569,2570,2571,2611,2612,2620,2626,2627,2650,2683,2685,2689,2692,2695,2704,2705,2708,2714,2715,2721,2728,2729,2742,2743,2749,2754,2773,2774,2780,2781,2784,2786,2792,2801,2802,2805,2809,2812,2814,2815,2828,2830,2834,2836,2849,2855,2861,2871,2872,2875,2878,2881,2896,2897,2898,2903,2910,2926,2931,2933,2934,2935,2940,2950,2958,2961,2964,2967,2968,2970,2976,2983,2994,3002,3005,3008,3019,3023,3036,3041,3054,3061,3073,3075,3116,3117,3122,3124,3132,3133,3143,3144,3169,3204,3205,3212,3266,3268,3271,3273,3274,3283,3285,3290,3292,3301,3303,3311,3315,3330,3336,3340,3363,3365,3366,3367,3395,3398,3414,3416,3419,3422,3425,3431,3442,3449,3450,3459,3464,3465,3467,3470,3480,3482,3491,3505,3515,3516,3517,3521,3524,3531,3534,3536,3542,3547,3554,3561,3594,3618,3654,3655,3662,3684,3693,3698,3702,3703,3728,3729,3730,3748,3763,3789,3793,3804,3835,3840,3869,3896,3899,3902,3919,3921,3952,4003,4031,4036,4037,4049,4050,4053,4062,4066,4069,4073,4106,4111,4140,4151,4152,4160,4163,4218,4221,4222,4228,4231,4236,4237,4240,4241,4250,4253,4262,4269,4270,4273,4276,4277,4278,4281,4283,4286,4287,4288,4291,4292,4293,4310,4312,4314,4319,4330,4357,4365,4367,4381,4394,4395,4407,4414,4423,4439,4440,4444,4447,4454,4456,4469,4470,4474,4476,4483,4485,4495,4510,4513,4514,4516,4531,4549,4561,4574,4575,4576,4577,4578,4584,4589,4593,4594,4595,4601,4602,4615,4624,4630,4634,4646,4649,4664,4680,4689,4706,4707,4708,4717,4757,4768,4772,4775,4808,4811,4812,4813,4814,4815,4819,4823,4828,4829,4831,4865,4866,4868,4877,4892,4903,4913,4914,4920,4926,4961,4969,4979,4980,4983,4984,4985,4987,4996,5008,5010,5016,5019,5027,5037,5038,5041,5044,5051,5052,5064,5068,5080,5082,5086,5091,5093,5096,5103,5105,5109,5111,5118,5121,5124,5134,5138,5144,5145,5146,5154,5158,5160,5161,5164,5170,5172,5173,5174,5175,5177,5178,5199,5200,5203,5209,5216,5237,5244,5247,5252,5254,5265,5266,5267,5271,5273,5280,5288,5298,5306,5321,5330,5331,5339,5354,5357,5360,5369,5371,5372,5387,5396,5405,5407,5408,5417,5431,5432,5436,5445,5447,5448,5449,5452,5455,5464,5466,5483,5486,5500,5502,5504,5505,5511,5522,5529,5538,5539,5541,5548,5555,5573,5579,5593,5594,5595,5596,5597,5606,5609,5610,5612,5615,5631,5639,5650,5652,5655,5673,5677,5684,5690,5697,5710,5717,5724,5741,5746,5747,5755,5758,5759,5761,5765,5770,5782,5786,5790,5796,5807,5815,5837,5844,5848,5852,5857,5858,5859,5860,5863,5864,5866,5868,5870,5871,5872,5873,5874,5876,5877,5879,5884,5885,5888,5892,5894,5902,5903,5907,5908,5909,5912,5913,5918,5922,5923,5927,5930,5936,5944,5947,5958,5959,5979,5981,5982,5984,5994,6000,6021,6029,6030,6031,6033,6047,6049,6050,6051,6063,6080,6086,6093,6097,6098,6101,6103,6104,6111,6121,6122,6123,6124,6134,6135,6136,6137,6142,6144,6150,6153,6158,6164,6170,6171,6174,6186,6191,6196,6210,6217,6225,6231,6239,6246,6252,6255,6266,6268,6277,6280,6281,6296,6298,6303,6306,6312,6332,6335,6338,6341,6343,6344,6363,6369,6384,6385,6386,6396,6399,6402,6405,6412,6413,6414,6422,6426,6441,6442,6443,6450,6452,6475,6485,6487,6493,6498,6505,6506,6508,6520,6527,6529,6530,6531,6532,6535,6537,6539,6543,6547,6549,6552,6556,6566,6588,6601,6608,6617,6620,6622,6628,6638,6639,6647,6649,6652,6661,6663,6681,6683,6684,6689,6705,6708,6710,6712,6714,6716,6719,6720,6723,6725,6726,6734,6735,6739,6742,6747,6764,6766,6767,6775,6777,6784,6790,6796,6801,6808,6819,6821,6824,6828,6829,6837,6842,6848,6850,6853,6887,6888,6895,6900,6902,6906,6909,6915,6919,6924,6927,6941,6956,6959,6968,6969,6993,6994,6998,6999,7005,7014,7033,7042,7043,7044,7047,7051,7052,7054,7055,7058,7073,7076,7119,7120,7121,7129,7134,7135,7136,7139,7141,7146,7148,7150,7160,7184,7187,7194,7197,7200,7207,7209,7214,7216,7220,7222,7225,7226,7230,7232,7235,7241,7242,7244,7249,7250,7252,7254,7255,7263,7266,7267,7268,7269,7270,7271,7273,7276,7278,7279,7291,7292,7293,7302,7325,7329,7333,7338,7344,7345,7346,7347,7353,7358,7366,7374,7390,7395,7399,7405,7406,7413,7420,7422,7425,7441,7460,7461,7463,7465,7470,7471,7474,7485,7487,7491,7498,7499,7517,7523,7527,7528,7532,7535,7537,7539,7548,7552,7555,7574,7586,7590,7607,7617,7619,7624,7632,7637,7641,7666,7670,7673,7676,7679,7682,7685,7692,7729,7731,7732,7741,7743,7747,7748,7765,7771,7775,7780,7782,7799,7802,7806,7807,7811,7814,7818,7819,7821,7831,7845,7848,7851,7867,7874,7875,7889,7895,7909,7919,7925,7937,7938,7939,7991,7994,7997,8008,8013,8033,8036,8045,8089,8094,8098,8103,8107,8114,8116,8130,8133,8134,8136,8140,8142,8143,8147,8160,8171,8180,8183,8184,8188,8195,8208,8215,8224,8235,8240,8251,8265,8266,8268,8270,8278,8290,8291,8295,8313,8314,8316,8335,8344,8368,8369,8434,8507,8521,8530,8544,8551,8552,8553,8572,8582,8590,8594,8596,8601,8606,8609,8619,8630,8651,8653,8655,8658,8666,8679,8680,8685,8686,8700,8708,8715,8720,8722,8737,8757,8764,8769,8774,8821,8827,8830,8845,8853,8854,8872,8880,8883,8889,8890,8893,8894,8899,8900,8928,8977,8979,8982,8984,8991,8992,8995,8996,8998,9000,9003,9004,9006,9035,9038,9050,9055,9056,9057,9064,9071,9075,9076,9077,9078,9079,9080,9081,9093,9095,9113,9115,9116,9123,9127,9128,9130,9131,9136,9137,9142,9156,9162,9164,9165,9171,9176,9185,9187,9188,9190,9194,9198,9203,9208,9217,9253,9258,9267,9268,9288,9293,9328,9333,9347,9348,9350,9353,9358,9359,9362,9367,9380,9381,9395,9400,9407,9419,9434,9440,9442,9445,9451,9455,9458,9468,9469,9482,9493,9497,9498,9499,9505,9508,9519,9524,9526,9529,9530,9534,9550,9551,9553,9556,9557,9558,9560,9570,9575,9579,9583,9586,9588,9589,9598,9600,9607,9612,9615,9616,9623,9625,9633,9646,9652,9656,9657,9669,9670,9688,9693,9695,9711,9712,9713,9716,9727,9730,9733,9736,9739,9744,9745,9747,9748,9749,9766,9768,9774,9778,9779,9782,9788,9794,9799,9808,9809,9811,9814,9815,9816,9817,9818,9820,9821,9822,9825,9831,9835,9848,9851,9854,9855,9885,9887,9888,9890,9898,9901,9908,9915,9922,9929,9935,9958,9969,9972,9974,9977,9984,9989,10004,10011,10021,10035,10036,10048,10049,10057,10076,10082,10090,10091,10095,10098];

async function searchAndExport() {
  let results = [];
  const endpoint = "https://api.moshtix.com/v1/graphql";

  const headers = {
    "content-type": "application/json"
  };
  let pageIndex = 0;
  let currSet = [];

  while (pageIndex == 0 || currSet.length > 0) {
    console.log(pageIndex);
    const graphqlQuery = {
      "operationName": "events",
      "query": `query {
          viewer {
        getEvents(eventStartDateFrom : "2024-12-08", venueIds : [${searchUrls}], pageSize : 100, pageIndex : ${pageIndex}) {
          items {
            id
            name
            artists {
              totalCount
              items {
                id
                name
              }
            }
            ticketTypes {
              items {
                ticketPrice
              }
            }
            startDate
            eventUrl
            venue {
              name
            }
          }
        }
      }
    }
    `,
      "variables": {}
    };

    const response = await axios({
      url: endpoint,
      method: 'post',
      headers: headers,
      data: graphqlQuery
    });

    currSet = response.data.data.viewer.getEvents.items;

    currSet.forEach(src => {
      // Perform the initial search and retrieve the total number of pages
        let result = {};
        result['Date'] = new Date(src.startDate).toLocaleString('en-AU').replace(",", "");
        result['Venue'] = src.venue.name;
        result['EventNameOrHeadliner'] = src.name;
        let arr = [];
        for (let el of src.artists.items) {
          arr.push(el["name"]);
        }
        console.log(result['Artists'] = arr.join(" + "));
        result['URL'] = src.eventUrl;
        result['IsFree'] = src.ticketTypes.items.some(el => {el.ticketPrice === 0});
        results.push(result);
      });

    pageIndex++;
  }

  // Export the results to a CSV file
  const csv = new ObjectsToCsv(results);
  await csv.toDisk('./scrape-moshtix.csv', { append: false });
}

// Example usage:
searchAndExport().then(() => {
  console.log('Search results exported to CSV file!');
}).catch((error) => {
  console.error(error);
});